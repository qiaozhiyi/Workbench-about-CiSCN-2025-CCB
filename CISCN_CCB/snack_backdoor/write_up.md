# CISCN CCB - Snack Backdoor 流量分析报告

## 1. 场景背景
近期发现公司网络出口出现异常通信，需通过分析 `attack.pcap` 流量包，定位失陷服务器，分析攻击路径，并提取后门木马的核心配置信息。

## 2. 漏洞分析与定位

### 2.1 暴力破解分析
通过分析 `attack.pcap`，发现攻击者（`192.168.1.111`）对目标服务器（`192.168.1.200:5000`）的 `/admin/login` 接口进行了密集的暴力破解。

*   **攻击特征**：大量包含 `username=admin` 的 POST 请求。
*   **登录成功标志**：在众多的 `Set-Cookie: session=;`（失败重置）之后，观察到服务器返回了 `HTTP/1.1 302 FOUND`，并重定向至 `/admin/panel`。同时，服务器下发了一个有效的 Flask session。
*   **成功密码**：通过匹配 302 响应之前的最后一次 POST 请求，确定爆破成功的密码为 `zxcvbnm123`。

### 2.2 SSTI 漏洞利用
攻击者在成功登录后台后，利用 `/admin/preview` 接口存在的 SSTI（服务端模板注入）漏洞执行了恶意 Python 代码。

*   **注入 Payload**：
    ```python
    {{url_for.__globals__['__builtins__']['exec']("import base64; exec(base64.b64decode('...'))", ...)}}
    ```
*   **执行逻辑**：该 Payload 通过 Base64 解码并执行了一段混淆后的 Python 代码，实现了在目标服务器上的远程代码执行（RCE）。

## 3. 木马深度分析

### 3.1 混淆代码解码
通过对流量中提取的 Base64 字符串进行解码，发现攻击者使用了嵌套的混淆方式：
1.  **第一层**：Base64 编码。
2.  **第二层**：代码定义了 `_ = lambda __ : zlib.decompress(base64.b64decode(__[::-1]))`。
3.  **还原方法**：需将混淆字符串反转，进行 Base64 解码，最后使用 zlib 进行解压。

### 3.2 木马配置提取
解码后的后门木马代码包含以下关键配置：
*   **外联地址 (C2)**：`112.34.111.149:80`
*   **通信密钥 (Key)**：`kira2025_secret`
*   **启动项位置**：木马通过修改系统配置文件或在用户目录下的启动脚本（如 `.bashrc`）中添加指令来实现持久化。

## 4. 总结
*   **成功密码**：`flag{zxcvbnm123}`
*   **攻击路径**：弱口令爆破 -> 后台 SSTI 漏洞 -> RCE 执行后门木马。
